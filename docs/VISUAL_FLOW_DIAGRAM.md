# Visual Flow Diagram: Contract Processing Pipeline

## ğŸ“Š Complete System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              USER BROWSER                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚  Upload    â”‚  â”‚  View      â”‚  â”‚  Review    â”‚  â”‚  Resolve   â”‚           â”‚
â”‚  â”‚  Contract  â”‚  â”‚  Clauses   â”‚  â”‚  Conflicts â”‚  â”‚  Issues    â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                â”‚                â”‚                â”‚
         â”‚ POST /upload   â”‚ GET /clauses   â”‚ GET /conflictsâ”‚ PATCH /resolve
         â”‚                â”‚                â”‚                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         NGINX REVERSE PROXY                                  â”‚
â”‚                         (Port 80 â†’ 8000)                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                â”‚                â”‚                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           FASTAPI APPLICATION                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  API Endpoints (app/api/v1/endpoints/)                          â”‚        â”‚
â”‚  â”‚  â”œâ”€ versions.py  â”€â”€â”€ upload_contract_version()                 â”‚        â”‚
â”‚  â”‚  â”œâ”€ contracts.py â”€â”€â”€ get_clauses(), get_conflicts()            â”‚        â”‚
â”‚  â”‚  â””â”€ conflicts.py â”€â”€â”€ analyze_conflicts(), resolve_conflict()   â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚            â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  Business Logic (app/services/)                                 â”‚        â”‚
â”‚  â”‚  â”œâ”€ document_parser.py â”€â”€â”€ Extract text from files             â”‚        â”‚
â”‚  â”‚  â”œâ”€ hierarchical_clause_extractor.py â”€â”€â”€ Parse clauses         â”‚        â”‚
â”‚  â”‚  â””â”€ llm_service.py â”€â”€â”€ Conflict detection with LLM             â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   FILE SYSTEM   â”‚          â”‚   POSTGRESQL    â”‚
â”‚                 â”‚          â”‚                 â”‚
â”‚  /app/uploads/  â”‚          â”‚  â”œâ”€ contracts   â”‚
â”‚  â”œâ”€ file1.pdf   â”‚          â”‚  â”œâ”€ versions    â”‚
â”‚  â”œâ”€ file2.docx  â”‚          â”‚  â”œâ”€ clauses â”€â”€â”€â”€â”€â”€â”€â–º parent_clause_id (HIERARCHY)
â”‚  â””â”€ file3.pdf   â”‚          â”‚  â””â”€ conflicts   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ Parse PDF
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   PDF PARSER    â”‚
â”‚  (PyMuPDF/      â”‚
â”‚   pdfplumber)   â”‚
â”‚                 â”‚
â”‚  Output: Text   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ Raw Text
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              HIERARCHICAL CLAUSE EXTRACTOR                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Phase 1: Detect Appendices                                    â”‚  â”‚
â”‚  â”‚  â”œâ”€ APPENDIX A at position 2500                               â”‚  â”‚
â”‚  â”‚  â””â”€ SCHEDULE 1 at position 3100                               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Phase 2: Find Boundaries                                      â”‚  â”‚
â”‚  â”‚  â”œâ”€ 1. at position 150                                        â”‚  â”‚
â”‚  â”‚  â”œâ”€ 1.1 at position 200                                       â”‚  â”‚
â”‚  â”‚  â”œâ”€ 2.1 at position 500                                       â”‚  â”‚
â”‚  â”‚  â””â”€ (a) at position 600                                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Phase 3-4: Extract Text                                       â”‚  â”‚
â”‚  â”‚  â”œâ”€ Clause 1: "DEFINITIONS..."                               â”‚  â”‚
â”‚  â”‚  â”œâ”€ Clause 1.1: "Affiliate means..."                         â”‚  â”‚
â”‚  â”‚  â””â”€ Clause 2.1: "The Supplier shall..."                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Phase 5: Build Hierarchy                                      â”‚  â”‚
â”‚  â”‚  â”œâ”€ 1 (depth=0, parent=None)                                  â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€ 1.1 (depth=1, parent='1')                             â”‚  â”‚
â”‚  â”‚  â””â”€ 2 (depth=0, parent=None)                                  â”‚  â”‚
â”‚  â”‚     â””â”€ 2.1 (depth=1, parent='2')                             â”‚  â”‚
â”‚  â”‚        â””â”€ (a) (depth=2, parent='2.1')                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Phase 6-7: Categorize & Detect Overrides                     â”‚  â”‚
â”‚  â”‚  â”œâ”€ 1.1 inherits "DEFINITIONS" from 1                        â”‚  â”‚
â”‚  â”‚  â””â”€ 2.2 tagged as override (contains "notwithstanding")      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                       â”‚
â”‚  Output: Structured Clauses with Hierarchy                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ List of clauses with parent_clause_id
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CELERY BACKGROUND WORKER                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Task: extract_clauses_task()                                  â”‚  â”‚
â”‚  â”‚  â”œâ”€ Step 1: Parse PDF                                         â”‚  â”‚
â”‚  â”‚  â”œâ”€ Step 2: Extract clauses (hierarchical)                    â”‚  â”‚
â”‚  â”‚  â”œâ”€ Step 3: Store in database (2-pass)                        â”‚  â”‚
â”‚  â”‚  â””â”€ Step 4: Trigger conflict detection                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Two-Pass Database Storage                                     â”‚  â”‚
â”‚  â”‚                                                                 â”‚  â”‚
â”‚  â”‚  Pass 1: INSERT all clauses                                    â”‚  â”‚
â”‚  â”‚  â”œâ”€ INSERT clause (1) â†’ UUID: a1b2c3d4                        â”‚  â”‚
â”‚  â”‚  â”œâ”€ INSERT clause (1.1) â†’ UUID: e5f6g7h8                      â”‚  â”‚
â”‚  â”‚  â””â”€ FLUSH (get UUIDs without committing)                      â”‚  â”‚
â”‚  â”‚                                                                 â”‚  â”‚
â”‚  â”‚  Pass 2: UPDATE parent relationships                           â”‚  â”‚
â”‚  â”‚  â”œâ”€ Map: '1' â†’ a1b2c3d4                                       â”‚  â”‚
â”‚  â”‚  â”œâ”€ Map: '1.1' â†’ e5f6g7h8                                     â”‚  â”‚
â”‚  â”‚  â”œâ”€ UPDATE clause (1.1) SET parent_id = a1b2c3d4             â”‚  â”‚
â”‚  â”‚  â””â”€ COMMIT                                                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ Clauses stored
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  CONFLICT DETECTION (LLM)                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Step 1: Load all clauses from database                        â”‚  â”‚
â”‚  â”‚  â”œâ”€ 42 clauses loaded                                          â”‚  â”‚
â”‚  â”‚  â””â”€ Filter: Remove 7 override clauses                          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Step 2: Group by category                                     â”‚  â”‚
â”‚  â”‚  â”œâ”€ PAYMENT: 8 clauses                                         â”‚  â”‚
â”‚  â”‚  â”œâ”€ CONFIDENTIALITY: 5 clauses                                 â”‚  â”‚
â”‚  â”‚  â””â”€ TERMINATION: 6 clauses                                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Step 3: Pairwise LLM Analysis                                 â”‚  â”‚
â”‚  â”‚                                                                 â”‚  â”‚
â”‚  â”‚  For each category:                                            â”‚  â”‚
â”‚  â”‚    For each clause pair:                                       â”‚  â”‚
â”‚  â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚  â”‚
â”‚  â”‚      â”‚  Ollama (qwen2.5:32b)              â”‚                   â”‚  â”‚
â”‚  â”‚      â”‚                                     â”‚                   â”‚  â”‚
â”‚  â”‚      â”‚  Prompt:                           â”‚                   â”‚  â”‚
â”‚  â”‚      â”‚  "Do these clauses conflict?"      â”‚                   â”‚  â”‚
â”‚  â”‚      â”‚                                     â”‚                   â”‚  â”‚
â”‚  â”‚      â”‚  Response:                          â”‚                   â”‚  â”‚
â”‚  â”‚      â”‚  {                                  â”‚                   â”‚  â”‚
â”‚  â”‚      â”‚    conflict: true,                 â”‚                   â”‚  â”‚
â”‚  â”‚      â”‚    severity: "high",               â”‚                   â”‚  â”‚
â”‚  â”‚      â”‚    explanation: "..."              â”‚                   â”‚  â”‚
â”‚  â”‚      â”‚  }                                  â”‚                   â”‚  â”‚
â”‚  â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚  â”‚
â”‚  â”‚                                                                 â”‚  â”‚
â”‚  â”‚  PAYMENT: 28 pairs â†’ 3 conflicts found                         â”‚  â”‚
â”‚  â”‚  CONFIDENTIALITY: 10 pairs â†’ 1 conflict found                  â”‚  â”‚
â”‚  â”‚  TERMINATION: 15 pairs â†’ 2 conflicts found                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Step 4: Store conflicts                                       â”‚  â”‚
â”‚  â”‚  â”œâ”€ INSERT conflict (clause 4.1 vs 4.4)                       â”‚  â”‚
â”‚  â”‚  â”œâ”€ INSERT conflict (clause 5.1 vs 5.3)                       â”‚  â”‚
â”‚  â”‚  â””â”€ COMMIT                                                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


## ğŸ”„ Message Flow (Redis/Celery)

```
FastAPI                    Redis                    Celery Worker
   â”‚                         â”‚                           â”‚
   â”‚ delay(extract_task)     â”‚                           â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                           â”‚
   â”‚                         â”‚                           â”‚
   â”‚ return task_id          â”‚                           â”‚
   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                           â”‚
   â”‚                         â”‚                           â”‚
   â”‚                         â”‚  fetch next task          â”‚
   â”‚                         â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                         â”‚                           â”‚
   â”‚                         â”‚  task payload             â”‚
   â”‚                         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
   â”‚                         â”‚                           â”‚
   â”‚                         â”‚                           â”‚ execute()
   â”‚                         â”‚                           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚                         â”‚                           â”‚        â”‚
   â”‚                         â”‚                           â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚                         â”‚                           â”‚
   â”‚                         â”‚  update status: SUCCESS   â”‚
   â”‚                         â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                         â”‚                           â”‚
```

## ğŸ—„ï¸ Database Relationships

```
contracts (id)
    â”‚
    â”‚ 1:N
    â–¼
contract_versions (id, contract_id)
    â”‚
    â”‚ 1:N
    â–¼
clauses (id, contract_version_id, parent_clause_id)
    â”‚
    â”‚ Self-Reference (parent â†’ child)
    â”‚
    â”œâ”€ clause_1 (parent=NULL, depth=0)
    â”‚   â”œâ”€ clause_1.1 (parent=clause_1, depth=1)
    â”‚   â””â”€ clause_1.2 (parent=clause_1, depth=1)
    â”‚
    â””â”€ clause_2 (parent=NULL, depth=0)
        â””â”€ clause_2.1 (parent=clause_2, depth=1)
            â”œâ”€ (a) (parent=clause_2.1, depth=2)
            â””â”€ (b) (parent=clause_2.1, depth=2)

conflicts (id, left_clause_id, right_clause_id)
    â”‚
    â”‚ N:1        N:1
    â–¼            â–¼
clauses (id)  clauses (id)
```

## ğŸ“ˆ Performance Timeline

```
Time (seconds)
    0 â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          â”‚ User clicks upload
          â”‚
    0.5 â”€â”€â”¼â”€ File saved to disk
          â”‚ Contract version created in DB
          â”‚ Celery task queued
          â”‚ [API returns 202 Accepted]
          â”‚
    1.0 â”€â”€â”¼â”€ Worker picks up task
          â”‚
    3.0 â”€â”€â”¼â”€ PDF parsing complete
          â”‚
    4.0 â”€â”€â”¼â”€ Clause extraction complete (42 clauses)
          â”‚
    4.5 â”€â”€â”¼â”€ Database storage complete (2-pass)
          â”‚
   35.0 â”€â”€â”¼â”€ Conflict detection complete
          â”‚ (630 pairwise LLM calls @ ~0.05s each)
          â”‚
   35.5 â”€â”€â”¼â”€ Conflicts stored in database
          â”‚ Task marked as SUCCESS
          â”‚ [Frontend can now fetch results]
          â”‚
   60.0 â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
```

## ğŸ” Example Request/Response Flow

### 1. Upload Request
```http
POST /api/v1/contracts/f81a968d.../versions/upload HTTP/1.1
Content-Type: multipart/form-data

------WebKitFormBoundary
Content-Disposition: form-data; name="file"; filename="contract.pdf"
Content-Type: application/pdf

%PDF-1.4 binary data...
------WebKitFormBoundary--
```

### 2. Upload Response
```json
HTTP/1.1 202 Accepted
{
  "version_id": "6c86821e-da33-401c-a3dd-0cacfa596b53",
  "task_id": "abc123-task-id",
  "status": "processing",
  "message": "Contract upload successful. Extraction in progress."
}
```

### 3. Poll Status (optional)
```http
GET /api/v1/tasks/abc123-task-id/status HTTP/1.1
```

```json
HTTP/1.1 200 OK
{
  "task_id": "abc123-task-id",
  "status": "PROCESSING",
  "progress": "Extracting clauses: 20/42 completed"
}
```

### 4. Fetch Clauses
```http
GET /api/v1/contracts/f81a968d.../clauses?version_id=6c86821e... HTTP/1.1
```

```json
HTTP/1.1 200 OK
{
  "clauses": [
    {
      "id": "a1b2c3d4...",
      "clause_number": "1",
      "heading": "DEFINITIONS AND INTERPRETATION",
      "text": "1. DEFINITIONS...",
      "depth_level": 0,
      "parent_clause_id": null,
      "is_override_clause": false,
      "children": [
        {
          "id": "e5f6g7h8...",
          "clause_number": "1.1",
          "heading": "Affiliate",
          "text": "1.1 \"Affiliate\" means...",
          "depth_level": 1,
          "parent_clause_id": "a1b2c3d4...",
          "is_override_clause": false,
          "children": []
        }
      ]
    }
  ]
}
```

### 5. Fetch Conflicts
```http
GET /api/v1/contracts/f81a968d.../conflicts?version_id=6c86821e... HTTP/1.1
```

```json
HTTP/1.1 200 OK
{
  "conflicts": [
    {
      "id": "conflict-1",
      "left_clause": {
        "id": "clause-5",
        "clause_number": "4.1",
        "text": "Payment within 30 days..."
      },
      "right_clause": {
        "id": "clause-12",
        "clause_number": "4.4",
        "text": "Payment within 7 days..."
      },
      "severity": "high",
      "explanation": "Conflicting payment terms: 30 days vs 7 days",
      "status": "UNRESOLVED"
    }
  ]
}
```

---

**End of Visual Flow Documentation**
